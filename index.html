<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WhatsApp DARSAP Mobile</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root {
            --bg-main: #0b141a; --bg-sidebar: #111b21; --bg-header: #202c33;
            --wa-green: #00a884; --text-main: #e9edef; --text-dim: #8696a0;
            --msg-out: #005c4b; --msg-in: #202c33;
        }

        body { 
            margin: 0; font-family: 'Segoe UI', Helvetica, Arial, sans-serif; 
            background: var(--bg-main); color: var(--text-main); 
            height: 100vh; display: flex; overflow: hidden; 
        }

        /* --- LAYOUT UTAMA --- */
        .container { display: flex; width: 100%; height: 100%; position: relative; }

        /* --- SIDEBAR (DAFTAR KONTAK) --- */
        .sidebar { 
            width: 30%; min-width: 300px; background: var(--bg-sidebar); 
            border-right: 1px solid #313d45; display: flex; flex-direction: column; 
            transition: all 0.3s ease;
        }

        /* --- CHAT AREA --- */
        .chat-area { 
            flex: 1; display: flex; flex-direction: column; 
            background: #0b141a url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); 
            background-blend-mode: overlay; transition: all 0.3s ease;
        }

        /* TAMPILAN HP (RESPONSIVE) */
        @media (max-width: 768px) {
            .sidebar { width: 100%; position: absolute; left: 0; z-index: 5; }
            .chat-area { width: 100%; position: absolute; left: 100%; z-index: 10; }
            .chat-area.active { left: 0; }
        }

        /* --- KOMPONEN UI --- */
        .header { 
            padding: 10px 16px; background: var(--bg-header); height: 60px; 
            display: flex; align-items: center; gap: 10px; box-sizing: border-box; 
        }

        .back-btn { display: none; cursor: pointer; font-size: 20px; padding-right: 10px; }
        @media (max-width: 768px) { .back-btn { display: block; } }

        .avatar { 
            width: 40px; height: 40px; border-radius: 50%; background: #53616a; 
            display: flex; align-items: center; justify-content: center; font-weight: bold; 
        }

        .contact-item { 
            padding: 15px; display: flex; align-items: center; border-bottom: 1px solid #222d34; cursor: pointer; 
        }

        .msg-container { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 5px; }
        .bubble { 
            max-width: 75%; padding: 8px 12px; border-radius: 8px; font-size: 14px; line-height: 1.4; 
            position: relative; word-wrap: break-word;
        }
        .in { background: var(--msg-in); align-self: flex-start; }
        .out { background: var(--msg-out); align-self: flex-end; }

        .input-bar { padding: 10px; background: var(--bg-header); display: flex; gap: 8px; align-items: center; }
        .input-bar input { 
            flex: 1; padding: 12px; border-radius: 25px; border: none; 
            background: #2a3942; color: white; outline: none; 
        }

        /* --- VIDEO CALL FULLSCREEN --- */
        #callOverlay { 
            position: fixed; inset: 0; background: black; z-index: 9999; 
            display: none; flex-direction: column; 
        }
        video#remoteVideo { width: 100%; height: 100%; object-fit: cover; }
        video#localVideo { 
            position: absolute; width: 30%; max-width: 120px; top: 20px; right: 20px; 
            border-radius: 10px; border: 2px solid white; z-index: 10000; 
        }
        .controls { 
            position: absolute; bottom: 30px; width: 100%; 
            display: flex; justify-content: center; gap: 20px; 
        }
        .btn-round { 
            width: 60px; height: 60px; border-radius: 50%; border: none; 
            color: white; font-size: 24px; cursor: pointer; 
        }

        .hidden { display: none !important; }
    </style>
</head>
<body>

<div class="container">
    <div class="sidebar" id="sidebar">
        <div class="header">
            <div id="myIdText" style="font-size: 12px; color: var(--wa-green); flex: 1;">Connecting...</div>
            <button onclick="addFriend()" style="background:none; border:none; color:var(--wa-green); font-size:25px; cursor:pointer;">+</button>
        </div>
        <div id="contactList" style="overflow-y: auto;"></div>
    </div>

    <div class="chat-area" id="chatArea">
        <div class="header">
            <span class="back-btn" onclick="closeChat()">‚Üê</span>
            <div class="avatar" id="activeAvatar">?</div>
            <div style="flex: 1;">
                <b id="activeName">Pilih Kontak</b><br>
                <small id="statusLine" style="font-size:11px; color:var(--text-dim);">Offline</small>
            </div>
            <div style="display:flex; gap:15px; font-size:20px; cursor:pointer;">
                <span onclick="startCall(false)">üìû</span>
                <span onclick="startCall(true)">üìπ</span>
            </div>
        </div>

        <div class="msg-container" id="msgContainer">
            <div style="margin: auto; text-align: center; color: var(--text-dim);">
                <p>Klik kontak untuk memulai chat ‚ù§Ô∏è</p>
            </div>
        </div>

        <form class="input-bar" id="chatForm">
            <input type="text" id="msgInput" placeholder="Ketik pesan..." autocomplete="off">
            <button type="submit" style="background:none; border:none; color:var(--wa-green); font-size:25px;">‚û§</button>
        </form>
    </div>
</div>

<div id="callOverlay">
    <video id="remoteVideo" autoplay playsinline></video>
    <video id="localVideo" autoplay playsinline muted></video>
    <div class="controls">
        <button class="btn-round" style="background:#3b4a54" onclick="toggleMute()">üéôÔ∏è</button>
        <button class="btn-round" style="background:#ff3b30" onclick="endCall()">‚ùå</button>
    </div>
</div>

<audio id="ringtone" src="https://actions.google.com/sounds/v1/alarms/phone_alerts_and_rings.ogg" loop></audio>

<script>
    let peer, myID, activeFriendId;
    let connections = {};
    let currentCall = null, localStream = null;

    // Database Sederhana
    let contacts = JSON.parse(localStorage.getItem('wa_hp_contacts') || '[]');
    let history = JSON.parse(localStorage.getItem('wa_hp_history') || '{}');

    window.onload = () => {
        myID = localStorage.getItem('my_wa_id') || prompt("Masukkan ID kamu:");
        if(!myID) return location.reload();
        localStorage.setItem('my_wa_id', myID);
        initPeer();
        renderContacts();
    };

    function initPeer() {
        peer = new Peer(myID);
        peer.on('open', id => document.getElementById('myIdText').innerText = "ID: " + id);
        peer.on('connection', conn => setupChat(conn));
        peer.on('call', async call => {
            if(confirm("Panggilan masuk! Terima?")) {
                document.getElementById('ringtone').play();
                await getMedia(true);
                call.answer(localStream);
                handleCall(call);
            }
        });
    }

    function addFriend() {
        const name = prompt("Nama:");
        const id = prompt("ID Teman:");
        if(name && id) {
            contacts.push({name, id});
            localStorage.setItem('wa_hp_contacts', JSON.stringify(contacts));
            renderContacts();
        }
    }

    function renderContacts() {
        const list = document.getElementById('contactList');
        list.innerHTML = "";
        contacts.forEach(c => {
            const el = document.createElement('div');
            el.className = "contact-item";
            el.onclick = () => openChat(c);
            el.innerHTML = `<div class="avatar" style="margin-right:15px">${c.name[0]}</div><b>${c.name}</b>`;
            list.appendChild(el);
        });
    }

    function openChat(contact) {
        activeFriendId = contact.id;
        document.getElementById('chatArea').classList.add('active');
        document.getElementById('activeName').innerText = contact.name;
        document.getElementById('activeAvatar').innerText = contact.name[0];
        renderMessages();

        if(!connections[contact.id] || !connections[contact.id].open) {
            setupChat(peer.connect(contact.id));
        } else {
            updateStatus("Online", "var(--wa-green)");
        }
    }

    function closeChat() {
        document.getElementById('chatArea').classList.remove('active');
    }

    function setupChat(conn) {
        connections[conn.peer] = conn;
        conn.on('open', () => {
            if(activeFriendId === conn.peer) updateStatus("Online", "var(--wa-green)");
        });
        conn.on('data', data => {
            saveMsg(conn.peer, 'in', data);
            if(activeFriendId === conn.peer) renderMessages();
        });
    }

    document.getElementById('chatForm').onsubmit = (e) => {
        e.preventDefault();
        const input = document.getElementById('msgInput');
        const text = input.value.trim();
        if(text && connections[activeFriendId]?.open) {
            connections[activeFriendId].send(text);
            saveMsg(activeFriendId, 'out', text);
            renderMessages();
            input.value = "";
        }
    };

    function saveMsg(id, type, text) {
        if(!history[id]) history[id] = [];
        history[id].push({type, text, time: new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})});
        localStorage.setItem('wa_hp_history', JSON.stringify(history));
    }

    function renderMessages() {
        const container = document.getElementById('msgContainer');
        container.innerHTML = "";
        (history[activeFriendId] || []).forEach(m => {
            const d = document.createElement('div');
            d.className = `bubble ${m.type}`;
            d.innerHTML = `${m.text} <div style="font-size:9px; opacity:0.5; text-align:right;">${m.time}</div>`;
            container.appendChild(d);
        });
        container.scrollTop = container.scrollHeight;
    }

    function updateStatus(txt, col) {
        const s = document.getElementById('statusLine');
        s.innerText = txt; s.style.color = col;
    }

    // --- CALL FUNCTIONS ---
    async function getMedia(vid) {
        localStream = await navigator.mediaDevices.getUserMedia({video: vid, audio: true});
        document.getElementById('localVideo').srcObject = localStream;
    }

    async function startCall(vid) {
        await getMedia(vid);
        document.getElementById('callOverlay').style.display = 'flex';
        handleCall(peer.call(activeFriendId, localStream));
    }

    function handleCall(call) {
        currentCall = call;
        call.on('stream', rs => {
            document.getElementById('ringtone').pause();
            document.getElementById('remoteVideo').srcObject = rs;
        });
        call.on('close', endCall);
    }

    function endCall() {
        if(currentCall) currentCall.close();
        if(localStream) localStream.getTracks().forEach(t => t.stop());
        document.getElementById('callOverlay').style.display = 'none';
        document.getElementById('ringtone').pause();
    }
</script>

</body>
</html>
