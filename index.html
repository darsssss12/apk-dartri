<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DARSAP Ultra Messenger</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root {
            --bg-dark: #0c1317;
            --sidebar-bg: #111b21;
            --header-bg: #202c33;
            --accent: #00a884;
            --text-primary: #e9edef;
            --text-secondary: #8696a0;
            --bubble-out: #005c4b;
            --bubble-in: #202c33;
            --glass: rgba(255, 255, 255, 0.05);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { 
            margin: 0; font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; 
            background: var(--bg-dark); color: var(--text-primary); 
            height: 100vh; display: flex; overflow: hidden;
        }

        /* --- LAYOUT --- */
        .app-wrapper { display: flex; width: 100%; height: 100%; position: relative; }

        .sidebar { 
            width: 30%; min-width: 320px; background: var(--sidebar-bg); 
            display: flex; flex-direction: column; border-right: 1px solid rgba(255,255,255,0.1);
            z-index: 10; transition: 0.3s ease;
        }

        .main-chat { 
            flex: 1; display: flex; flex-direction: column; 
            background: #0b141a url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png');
            background-blend-mode: overlay; position: relative; transition: 0.3s ease;
        }

        @media (max-width: 768px) {
            .sidebar { width: 100%; position: absolute; left: 0; }
            .main-chat { width: 100%; position: absolute; left: 100%; }
            .main-chat.active { left: 0; }
        }

        /* --- UI COMPONENTS --- */
        .header { 
            height: 65px; background: var(--header-bg); padding: 0 16px; 
            display: flex; align-items: center; justify-content: space-between;
        }

        .user-info { display: flex; align-items: center; gap: 12px; cursor: pointer; }
        .avatar { 
            width: 40px; height: 40px; border-radius: 50%; background: #53616a;
            display: flex; align-items: center; justify-content: center; 
            overflow: hidden; object-fit: cover; border: 1.5px solid var(--accent);
        }
        .avatar img { width: 100%; height: 100%; object-fit: cover; }

        .search-box { padding: 10px; background: var(--sidebar-bg); }
        .search-inner { 
            background: var(--header-bg); border-radius: 8px; padding: 6px 12px;
            display: flex; align-items: center; gap: 10px;
        }
        .search-inner input { 
            background: none; border: none; color: white; outline: none; width: 100%; font-size: 14px;
        }

        .contact-list { flex: 1; overflow-y: auto; }
        .contact-card { 
            padding: 12px 16px; display: flex; align-items: center; gap: 15px;
            cursor: pointer; border-bottom: 0.5px solid rgba(255,255,255,0.05);
        }
        .contact-card:hover { background: rgba(255,255,255,0.03); }
        .card-meta { flex: 1; overflow: hidden; }
        .card-meta b { font-size: 16px; display: block; }
        .card-meta small { color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block; }

        /* --- MESSAGES --- */
        .msg-area { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 6px; }
        .bubble { 
            max-width: 70%; padding: 8px 12px; border-radius: 10px; font-size: 14.5px;
            position: relative; animation: pop 0.2s ease;
        }
        @keyframes pop { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        
        .bubble.out { background: var(--bubble-out); align-self: flex-end; border-top-right-radius: 2px; }
        .bubble.in { background: var(--bubble-in); align-self: flex-start; border-top-left-radius: 2px; }
        .bubble img { max-width: 100%; border-radius: 8px; margin-top: 5px; cursor: pointer; }
        .time { font-size: 10px; opacity: 0.6; float: right; margin-top: 5px; margin-left: 10px; }

        /* --- INPUT AREA --- */
        .input-bar { 
            padding: 10px 16px; background: var(--header-bg); 
            display: flex; align-items: center; gap: 12px;
        }
        .input-bar input { 
            flex: 1; background: #2a3942; border: none; padding: 12px 16px;
            border-radius: 20px; color: white; outline: none;
        }
        .icon-btn { cursor: pointer; font-size: 20px; color: var(--text-secondary); transition: 0.2s; }
        .icon-btn:hover { color: var(--accent); }

        /* --- MODALS --- */
        .overlay { 
            position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 1000;
            display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px);
        }
        .modal { background: var(--header-bg); padding: 24px; border-radius: 16px; width: 90%; max-width: 400px; }
        .modal input { width: 100%; padding: 12px; margin: 10px 0; border-radius: 8px; border: none; background: #2a3942; color: white; }
        .btn-act { padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; }

        /* --- CALL SCREEN --- */
        #callUI { 
            position: fixed; inset: 0; background: radial-gradient(circle, #202c33 0%, #0b141a 100%);
            z-index: 5000; display: none; flex-direction: column; align-items: center; justify-content: center;
        }
        video#remoteVideo { width: 100%; height: 100%; object-fit: cover; }
        video#localVideo { 
            position: absolute; top: 30px; right: 30px; width: 100px; height: 140px;
            border-radius: 12px; border: 2px solid white; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
    </style>
</head>
<body>

<div class="app-wrapper">
    <div class="sidebar">
        <div class="header">
            <div class="user-info" onclick="openProfile()">
                <div class="avatar" id="myAvatar"><img id="myAvatarImg" src=""></div>
                <b id="myName">Sobat Darsap</b>
            </div>
            <div style="display: flex; gap: 15px;">
                <span class="icon-btn" onclick="openAddFriend()">‚ûï</span>
            </div>
        </div>
        
        <div class="search-box">
            <div class="search-inner">
                <span>üîç</span>
                <input type="text" id="searchContact" placeholder="Cari kontak..." onkeyup="filterContacts()">
            </div>
        </div>

        <div class="contact-list" id="contactContainer"></div>
    </div>

    <div class="main-chat" id="chatPanel">
        <div id="noActiveChat" style="margin: auto; text-align: center; color: var(--text-secondary);">
            <div style="font-size: 80px; margin-bottom: 20px;">üí¨</div>
            <h2>DARSAP ULTRA</h2>
            <p>Pilih teman atau tambahkan ID untuk mulai mengobrol.</p>
        </div>

        <div id="activeChatUI" style="display: none; height: 100%; flex-direction: column;">
            <div class="header">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <span class="icon-btn" onclick="closeChat()">‚¨ÖÔ∏è</span>
                    <div class="avatar" id="activeAvatar"></div>
                    <div>
                        <b id="activeName">Nama Teman</b><br>
                        <small id="activeStatus" style="color: var(--accent); font-size: 11px;">online</small>
                    </div>
                </div>
                <div style="display: flex; gap: 20px;">
                    <span class="icon-btn" onclick="startCall(false)">üìû</span>
                    <span class="icon-btn" onclick="startCall(true)">üìπ</span>
                </div>
            </div>

            <div class="msg-area" id="msgBox"></div>

            <div class="input-bar">
                <span class="icon-btn" onclick="document.getElementById('imageInput').click()">üìé</span>
                <input type="file" id="imageInput" hidden accept="image/*" onchange="sendImage(this)">
                <input type="text" id="chatInput" placeholder="Ketik pesan..." autocomplete="off">
                <span class="icon-btn" id="voiceBtn" onmousedown="startRecording()" onmouseup="stopRecording()">üéôÔ∏è</span>
                <span class="icon-btn" onclick="sendMessage()" style="color: var(--accent);">‚û§</span>
            </div>
        </div>
    </div>
</div>

<div class="overlay" id="profileModal">
    <div class="modal">
        <h3>Edit Profil</h3>
        <center>
            <div class="avatar" style="width: 100px; height: 100px; margin-bottom: 10px;" onclick="document.getElementById('profileFile').click()">
                <img id="profilePrev" src="">
            </div>
            <input type="file" id="profileFile" hidden onchange="prevProfile(this)">
            <small style="color: var(--accent)">ID: <span id="myFullId"></span></small>
        </center>
        <input type="text" id="editName" placeholder="Nama Kamu">
        <div style="display: flex; gap: 10px; margin-top: 15px;">
            <button class="btn-act" onclick="hideAllModals()" style="background: #3b4a54; color: white; flex: 1;">Batal</button>
            <button class="btn-act" onclick="saveProfile()" style="background: var(--accent); color: white; flex: 1;">Simpan</button>
        </div>
    </div>
</div>

<div class="overlay" id="addFriendModal">
    <div class="modal">
        <h3>Tambah Teman</h3>
        <input type="text" id="newFriendName" placeholder="Nama Panggilan">
        <input type="text" id="newFriendId" placeholder="Peer ID Teman">
        <div style="display: flex; gap: 10px; margin-top: 15px;">
            <button class="btn-act" onclick="hideAllModals()" style="background: #3b4a54; color: white; flex: 1;">Batal</button>
            <button class="btn-act" onclick="confirmAddFriend()" style="background: var(--accent); color: white; flex: 1;">Tambah</button>
        </div>
    </div>
</div>

<div id="callUI">
    <video id="remoteVideo" autoplay playsinline></video>
    <video id="localVideo" autoplay playsinline muted></video>
    <div style="position: absolute; bottom: 50px; display: flex; gap: 25px;">
        <button class="btn-act" style="width: 65px; height: 65px; border-radius: 50%; background: #3b4a54; font-size: 24px;" onclick="muteAudio()">üéôÔ∏è</button>
        <button class="btn-act" style="width: 65px; height: 65px; border-radius: 50%; background: #ff3b30; font-size: 24px;" onclick="endCall()">‚ùå</button>
    </div>
</div>

<audio id="ringtone" src="https://actions.google.com/sounds/v1/alarms/phone_alerts_and_rings.ogg" loop></audio>

<script>
    let peer, myID, activeFriend;
    let connections = {};
    let localStream, currentCall, mediaRecorder, audioChunks = [];

    // Local DB
    let myProfile = JSON.parse(localStorage.getItem('ultra_profile') || '{"name":"User Darsap", "photo":""}');
    let contacts = JSON.parse(localStorage.getItem('ultra_contacts') || '[]');
    let history = JSON.parse(localStorage.getItem('ultra_history') || '{}');

    window.onload = () => {
        myID = localStorage.getItem('ultra_my_id') || Math.random().toString(36).substr(2, 6);
        localStorage.setItem('ultra_my_id', myID);
        initPeer();
        updateProfileUI();
        renderContacts();
    };

    function initPeer() {
        peer = new Peer(myID);
        peer.on('open', id => document.getElementById('myFullId').innerText = id);
        peer.on('connection', conn => setupDataConn(conn));
        peer.on('call', async call => {
            if(confirm("Panggilan Masuk! Terima?")) {
                document.getElementById('ringtone').play();
                await getMedia(call.options.metadata?.video);
                call.answer(localStream);
                handleCall(call);
            }
        });
    }

    // --- PROFILE ---
    function openProfile() {
        document.getElementById('editName').value = myProfile.name;
        document.getElementById('profilePrev').src = myProfile.photo;
        document.getElementById('profileModal').style.display = 'flex';
    }

    function prevProfile(input) {
        let reader = new FileReader();
        reader.onload = e => document.getElementById('profilePrev').src = e.target.result;
        reader.readAsDataURL(input.files[0]);
    }

    function saveProfile() {
        myProfile.name = document.getElementById('editName').value;
        myProfile.photo = document.getElementById('profilePrev').src;
        localStorage.setItem('ultra_profile', JSON.stringify(myProfile));
        updateProfileUI();
        hideAllModals();
        Object.values(connections).forEach(c => c.send({type:'sync_profile', data: myProfile}));
    }

    function updateProfileUI() {
        document.getElementById('myName').innerText = myProfile.name;
        if(myProfile.photo) document.getElementById('myAvatarImg').src = myProfile.photo;
    }

    // --- CONTACTS ---
    function openAddFriend() { document.getElementById('addFriendModal').style.display = 'flex'; }

    function confirmAddFriend() {
        const name = document.getElementById('newFriendName').value;
        const id = document.getElementById('newFriendId').value;
        if(name && id) {
            contacts.push({name, id, photo:'', lastMsg:''});
            localStorage.setItem('ultra_contacts', JSON.stringify(contacts));
            renderContacts();
            hideAllModals();
        }
    }

    function renderContacts() {
        const cont = document.getElementById('contactContainer');
        cont.innerHTML = "";
        contacts.forEach(c => {
            const last = history[c.id] ? history[c.id][history[c.id].length-1].content : 'Belum ada pesan';
            const html = `
                <div class="contact-card" onclick="openChat('${c.id}')">
                    <div class="avatar">${c.photo ? `<img src="${c.photo}">` : c.name[0]}</div>
                    <div class="card-meta">
                        <b>${c.name}</b>
                        <small>${last}</small>
                    </div>
                </div>`;
            cont.insertAdjacentHTML('beforeend', html);
        });
    }

    // --- CHAT LOGIC ---
    function openChat(id) {
        activeFriend = contacts.find(c => c.id === id);
        document.getElementById('noActiveChat').style.display = 'none';
        document.getElementById('activeChatUI').style.display = 'flex';
        document.getElementById('chatPanel').classList.add('active');
        document.getElementById('activeName').innerText = activeFriend.name;
        
        const av = document.getElementById('activeAvatar');
        av.innerHTML = activeFriend.photo ? `<img src="${activeFriend.photo}">` : activeFriend.name[0];

        renderMessages();
        if(!connections[id]) setupDataConn(peer.connect(id));
    }

    function setupDataConn(conn) {
        connections[conn.peer] = conn;
        conn.on('open', () => conn.send({type:'sync_profile', data: myProfile}));
        conn.on('data', data => {
            if(data.type === 'sync_profile') {
                let friend = contacts.find(c => c.id === conn.peer);
                if(friend) { friend.name = data.data.name; friend.photo = data.data.photo; }
                renderContacts();
            } else {
                saveMsg(conn.peer, 'in', data.type, data.content);
                if(activeFriend?.id === conn.peer) renderMessages();
            }
        });
    }

    function sendMessage() {
        const input = document.getElementById('chatInput');
        const text = input.value.trim();
        if(text && connections[activeFriend.id]?.open) {
            connections[activeFriend.id].send({type:'text', content: text});
            saveMsg(activeFriend.id, 'out', 'text', text);
            renderMessages();
            input.value = "";
        }
    }

    function sendImage(input) {
        if(input.files[0]) {
            let reader = new FileReader();
            reader.onload = e => {
                connections[activeFriend.id].send({type:'image', content: e.target.result});
                saveMsg(activeFriend.id, 'out', 'image', e.target.result);
                renderMessages();
            };
            reader.readAsDataURL(input.files[0]);
        }
    }

    // --- RECORDING ---
    async function startRecording() {
        const stream = await navigator.mediaDevices.getUserMedia({audio: true});
        mediaRecorder = new MediaRecorder(stream);
        mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
        mediaRecorder.onstop = () => {
            const blob = new Blob(audioChunks, {type: 'audio/ogg'});
            const reader = new FileReader();
            reader.onload = e => {
                connections[activeFriend.id].send({type:'audio', content: e.target.result});
                saveMsg(activeFriend.id, 'out', 'audio', e.target.result);
                renderMessages();
            };
            reader.readAsDataURL(blob);
            audioChunks = [];
        };
        mediaRecorder.start();
        document.getElementById('voiceBtn').style.color = 'red';
    }

    function stopRecording() {
        mediaRecorder.stop();
        document.getElementById('voiceBtn').style.color = 'var(--text-secondary)';
    }

    function saveMsg(id, dir, type, content) {
        if(!history[id]) history[id] = [];
        history[id].push({dir, type, content, time: new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})});
        localStorage.setItem('ultra_history', JSON.stringify(history));
        renderContacts();
    }

    function renderMessages() {
        const box = document.getElementById('msgBox');
        box.innerHTML = "";
        (history[activeFriend.id] || []).forEach(m => {
            let body = m.content;
            if(m.type === 'image') body = `<img src="${m.content}" onclick="window.open(this.src)">`;
            if(m.type === 'audio') body = `<audio controls src="${m.content}" style="width:200px"></audio>`;
            
            const html = `<div class="bubble ${m.dir}">${body}<span class="time">${m.time}</span></div>`;
            box.insertAdjacentHTML('beforeend', html);
        });
        box.scrollTop = box.scrollHeight;
    }

    // --- CALLS ---
    async function getMedia(vid) {
        localStream = await navigator.mediaDevices.getUserMedia({video: vid, audio: true});
        document.getElementById('localVideo').srcObject = localStream;
        document.getElementById('localVideo').style.display = vid ? 'block' : 'none';
    }

    async function startCall(vid) {
        await getMedia(vid);
        document.getElementById('callUI').style.display = 'flex';
        handleCall(peer.call(activeFriend.id, localStream, {metadata:{video:vid}}));
    }

    function handleCall(call) {
        currentCall = call;
        call.on('stream', rs => {
            document.getElementById('ringtone').pause();
            document.getElementById('remoteVideo').srcObject = rs;
        });
        call.on('close', endCall);
    }

    function endCall() {
        if(currentCall) currentCall.close();
        if(localStream) localStream.getTracks().forEach(t => t.stop());
        document.getElementById('callUI').style.display = 'none';
        document.getElementById('ringtone').pause();
    }

    // --- UTILS ---
    function hideAllModals() {
        document.querySelectorAll('.overlay').forEach(o => o.style.display = 'none');
    }
    function closeChat() { document.getElementById('chatPanel').classList.remove('active'); }
    function muteAudio() { localStream.getAudioTracks()[0].enabled = !localStream.getAudioTracks()[0].enabled; }
    function filterContacts() {
        const q = document.getElementById('searchContact').value.toLowerCase();
        document.querySelectorAll('.contact-card').forEach(c => {
            c.style.display = c.innerText.toLowerCase().includes(q) ? 'flex' : 'none';
        });
    }
</script>

</body>
</html>
